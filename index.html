<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title> LD34 - Creeper! </title>
		<style> 
			* { padding: 0; margin: 0; }
			canvas { background: "cream"; display: block; margin: 0 auto; }
		</style> 
	</head>
	<body>
		<p> Instructions go here. </p>
		<canvas id="game" width="640" height="480"> Canvas goes here! </canvas>
		<script>
			var canvas = document.getElementById("game");
			var ctx    = canvas.getContext("2d");

			var game_over = false;
			var score     = 0;

			function rand_int(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

			var blocks = [ 
				[ 1, 0, 0, 0, 0 ],
				[ 0, 0, 0, 0, 0 ],
				[ 0, 0, 1, 1, 0 ],
				[ 1, 0, 1, 0, 0 ],
				[ 1, 0, 0, 0, 0 ],
				[ 1, 0, 0, 0, 0 ],
				[ 1, 0, 0, 0, 0 ]
			];

			var num_x = blocks[0].length; // 5
			var num_y = blocks.length; // 7
			var block_w = canvas.width/(num_x + 2);
			var block_h = canvas.height/(num_y);
			var left_edge = 2 * block_w;
			var top_edge = 0;


			function canv_pos_of(x, y) { return({ x: left_edge + block_w/2 + x * block_w, y: top_edge + block_h/2 + y * block_h })	}
			function draw_block(x, y) {
				block_center = canv_pos_of(x, y);
				ctx.fillStyle = "steelblue";
				ctx.strokeStyle = "darkblue";
				ctx.fillRect(block_center.x - block_w/2, block_center.y - block_h/2, block_w, block_h);
				ctx.strokeRect(block_center.x - block_w/2, block_center.y - block_h/2, block_w, block_h);
			}

			function draw_all_blocks() {
				for (row = 0; row < num_y; row++) {
					for (col = 0; col < num_x; col++) {
						if (blocks[row][col] == 1) draw_block(col, row);
			} } }

			var pattern_library = [
				(function() { // pattern1
					return([
						[ 1, 0, 0, 0, 1],
						[ 1, 0, 0, 1, 1],
						[ 1, 1, 0, 0, 0],
						[ 1, 1, 1, 0, 1]
					])
				}),

				(function() { // gates
					 var result = [
						[ 1, 1, 1, 1, 1 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 1, 1, 1, 1, 1 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 1, 1, 1, 1, 1 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 1, 1, 1, 1, 1 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 1, 1, 1, 1, 1 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 1, 1, 1, 1, 1 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
						[ 0, 0, 0, 0, 0 ],
					 ];

					bias = rand_int(1, 2);

					for(i = 0; i < 6; i++) {
						where_open = rand_int(bias - 1, num_x - bias);
						result[i * 5][where_open] = 0;
					}
					return(result);
				})
			];

			var buffer_pattern = [
				[ 0, 0, 0, 0, 0 ],
				[ 0, 0, 0, 0, 0 ],
			//	[ 0, 0, 0, 0, 0 ],
				[ 0, 0, 0, 0, 0 ],
			];

			var queued_pattern = buffer_pattern;

			function go_up (queued_pattern) { blocks.pop(); blocks.unshift(queued_pattern.pop()); }
			function update_block_positions () {
				if (queued_pattern.length <= 3) {
					upcoming_pattern = pattern_library[rand_int(0, pattern_library.length - 1)]();
					queued_pattern = upcoming_pattern.concat(buffer_pattern).concat(queued_pattern);
				}
				go_up(queued_pattern);
			}

			setInterval(update_block_positions, 150);

			function draw_bg () {
				ctx.fillStyle = "#eee";
				ctx.fillRect(left_edge, top_edge, num_x * block_w, num_y * block_h);
			}

			var player = {
				x      : 1, 
				y      : 4,
				r      : 12,
				draw   : function () { draw_ball(player.x, player.y, player.r) },
				shiftl : function () { if (player.x > 0)         { score += 10; player.x-- } },
				shiftr : function () { if (player.x < num_x - 1) { score += 10; player.x++ } }
			}

			function draw_ball(x, y, r) {
				ball_center = canv_pos_of(x, y);
				ctx.fillStyle = "gold"; 
				ctx.lineWidth = 4;
				ctx.strokeStyle = "orange";
				ctx.beginPath();
				ctx.arc(ball_center.x, ball_center.y, r, 0, Math.PI * 2);
				ctx.closePath();
				ctx.fill(); ctx.stroke();
			}

			function are_you_dead () { 
				if (score <= 0) game_over = true;
				for (car of cars) {
					if (player.lane == car.lane && player.y <= car.y + car.h/2 && player.y >= car.y - car.h/2) game_over = true;
				}
			} 
			
			function draw_frame() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				draw_bg();
				draw_all_blocks();
				player.draw();
				ctx.fillText("Score: " + score, 40, 40);

				requestAnimationFrame(draw_frame);
			}
			
			function keyDownHandler(e) {
				if (e.keyCode == 37 || e.keyCode == 65) player.shiftl();
				if (e.keyCode == 39 || e.keyCode == 68) player.shiftr();
			}
			document.addEventListener("keydown", keyDownHandler, false);
			draw_frame()
		</script>
	</body>
</html>

